<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Khelo Bangladesh</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #4361ee;
            --primary-hover: #3a56d4;
            --bg-body: #f3f4f6;
            --bg-nav: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --sidebar-width: 260px;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            height: 100vh;
            width: var(--sidebar-width);
            position: fixed;
            top: 0; left: 0;
            background: var(--bg-nav);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar-brand {
            padding: 24px;
            font-size: 22px;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.5px;
        }

        .nav-menu {
            padding: 10px 15px;
            flex: 1;
            overflow-y: auto;
        }

        .nav-link {
            color: var(--text-muted);
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 15px;
        }

        .nav-link:hover, .nav-link.active {
            background-color: #eef2ff;
            color: var(--primary);
            font-weight: 600;
        }
        
        .nav-link i { width: 22px; text-align: center; font-size: 16px; }

        /* --- MOBILE TOGGLE --- */
        .mobile-header {
            display: none;
            background: white;
            padding: 15px 20px;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1001;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
            transition: all 0.3s ease;
        }

        /* --- CARDS & UI --- */
        .card-box {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255,255,255,0.5);
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); }

        .stat-icon {
            width: 56px; height: 56px;
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
        }
        .sc-blue { background: #eff6ff; color: #3b82f6; }
        .sc-green { background: #ecfdf5; color: #10b981; }
        .sc-orange { background: #fff7ed; color: #f97316; }
        .sc-red { background: #fef2f2; color: #ef4444; }

        .sc-val { font-size: 26px; font-weight: 800; margin: 0; color: #111; }
        .sc-label { font-size: 14px; color: #888; margin: 0; font-weight: 500; }

        /* --- TABLES & FORMS --- */
        .table img { width: 44px; height: 44px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; }
        .table thead th { font-weight: 600; color: #6b7280; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; background: #f9fafb; border-bottom: 1px solid var(--border-color); padding: 12px; }
        .table tbody td { padding: 12px; vertical-align: middle; }
        
        .form-control, .form-select { padding: 12px 16px; border-radius: 10px; border: 1px solid #d1d5db; font-size: 14px; }
        .form-control:focus, .form-select:focus { box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1); border-color: var(--primary); }
        
        .btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; transition: all 0.2s; }
        .btn-primary { background: var(--primary); border: none; box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }

        /* --- MODAL TABS & PREVIEW --- */
        .modal-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .m-tab { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: #666; }
        .m-tab.active { background: #eef2ff; color: var(--primary); }
        
        .img-preview-box {
            width: 100%; height: 160px;
            background: #f9fafb;
            border-radius: 12px;
            margin-top: 15px;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            border: 2px dashed #d1d5db;
        }
        .img-preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 260px; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 15px; }
            .mobile-header { display: flex; }
            .nav-overlay {
                display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.4); z-index: 999; backdrop-filter: blur(2px);
            }
            .nav-overlay.active { display: block; }
        }

        .hidden { display: none !important; }
        
        /* Loading Spinner */
        .loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.9); z-index: 3000;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay hidden">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <div style="margin-top: 15px; font-weight: 600; color: var(--text-main);">Processing...</div>
    </div>

    <div class="nav-overlay" onclick="toggleSidebar()"></div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <div style="font-weight: 700; color: var(--primary); font-size: 18px;"><i class="fas fa-gamepad"></i> ADMIN PANEL</div>
        <button class="btn btn-light border" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <i class="fas fa-gamepad"></i> KHELO BD
        </div>
        <div class="nav-menu">
            <div class="nav-link active" onclick="switchView('dashboard', this)"><i class="fas fa-chart-pie"></i> Dashboard</div>
            <div class="nav-link" onclick="switchView('matches', this)"><i class="fas fa-trophy"></i> Matches</div>
            <div class="nav-link" onclick="switchView('categories', this)"><i class="fas fa-th-large"></i> Categories</div>
            <div class="nav-link" onclick="switchView('sliders', this)"><i class="fas fa-images"></i> Sliders</div>
            <div class="nav-link" onclick="switchView('users', this)"><i class="fas fa-users"></i> Users</div>
            <div class="nav-link" onclick="switchView('withdraw', this)"><i class="fas fa-wallet"></i> Withdrawals</div>
            <div class="nav-link" onclick="switchView('settings', this)"><i class="fas fa-cog"></i> Settings</div>
            <div class="nav-link" onclick="switchView('notifications', this)"><i class="fas fa-bell"></i> Notifications</div>
        </div>
        <div style="padding: 20px; font-size: 11px; text-align: center; color: #9ca3af; border-top: 1px solid var(--border-color);">
            Admin Pro v3.1
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard">
            <h4 class="mb-4 fw-bold">Dashboard Overview</h4>
            
            <div class="row">
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <div>
                            <p class="sc-label">Total Users</p>
                            <h3 class="sc-val" id="dash-users">0</h3>
                        </div>
                        <div class="stat-icon sc-blue"><i class="fas fa-users"></i></div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <div>
                            <p class="sc-label">Total Deposit</p>
                            <h3 class="sc-val">৳ <span id="dash-deposit">0</span></h3>
                        </div>
                        <div class="stat-icon sc-green"><i class="fas fa-arrow-down"></i></div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <div>
                            <p class="sc-label">Pending Req</p>
                            <h3 class="sc-val" id="dash-pending">0</h3>
                        </div>
                        <div class="stat-icon sc-orange"><i class="fas fa-clock"></i></div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card">
                        <div>
                            <p class="sc-label">Matches</p>
                            <h3 class="sc-val" id="dash-matches">0</h3>
                        </div>
                        <div class="stat-icon sc-red"><i class="fas fa-gamepad"></i></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8 mb-4">
                    <div class="card-box h-100">
                        <h6 class="mb-4 fw-bold">Analytics</h6>
                        <div style="position: relative; height: 300px;">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                     <div class="card-box h-100">
                        <h6 class="mb-4 fw-bold">Financial Ratio</h6>
                        <div style="position: relative; height: 250px;">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CATEGORIES VIEW -->
        <div id="view-categories" class="hidden">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold">Game Categories</h4>
                <button class="btn btn-primary" onclick="openCategoryModal()">+ Add Category</button>
            </div>
            <div class="row g-3" id="cat-grid"></div>
        </div>

        <!-- SLIDERS VIEW -->
        <div id="view-sliders" class="hidden">
             <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold">Home Sliders</h4>
                <button class="btn btn-primary" onclick="openBannerModal()">+ Add Banner</button>
            </div>
            <div class="row g-3" id="banner-grid"></div>
        </div>

        <!-- MATCHES VIEW -->
        <div id="view-matches" class="hidden">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold">Match Management</h4>
                <button class="btn btn-primary" onclick="openMatchModal()">+ Create Match</button>
            </div>
            <div class="card-box table-responsive">
                <table class="table align-middle table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Details</th>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Room</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="matches-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- USERS VIEW -->
        <div id="view-users" class="hidden">
            <h4 class="fw-bold">User Database</h4>
            <div class="input-group mb-3 mt-3" style="max-width: 400px;">
                <input type="text" id="user-search" class="form-control" placeholder="Search by name, phone or UID...">
                <button class="btn btn-outline-secondary" onclick="renderUsers()">Search</button>
            </div>
            <div class="card-box table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>User Info</th>
                            <th>Contact</th>
                            <th>Deposit</th>
                            <th>Winning</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- WITHDRAW VIEW -->
        <div id="view-withdraw" class="hidden">
            <h4 class="fw-bold">Withdrawal Requests</h4>
            <div class="card-box table-responsive mt-3">
                <table class="table align-middle table-hover">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Account No</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="withdraw-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="view-settings" class="hidden">
            <h4 class="fw-bold">App Settings</h4>
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card-box">
                        <h6 class="mb-3 text-primary"><i class="fab fa-youtube"></i> Tutorial Links</h6>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Add Money Video</label>
                            <input type="text" id="set-vid-money" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Get Room Video</label>
                            <input type="text" id="set-vid-room" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Join Match Video</label>
                            <input type="text" id="set-vid-play" class="form-control">
                        </div>
                        <button class="btn btn-dark w-100" onclick="saveLinks()">Save Links</button>
                    </div>

                    <div class="card-box">
                        <h6 class="mb-3 text-primary"><i class="fas fa-bullhorn"></i> Marquee Notice</h6>
                        <textarea id="set-notice" class="form-control" rows="3"></textarea>
                        <button class="btn btn-dark w-100 mt-2" onclick="saveNotice()">Update Notice</button>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card-box">
                        <h6 class="mb-3 text-primary"><i class="fas fa-wallet"></i> Payment Details</h6>
                        <div class="mb-3">
                            <label class="form-label small text-muted">bKash Number</label>
                            <input type="text" id="set-bkash" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Nagad Number</label>
                            <input type="text" id="set-nagad" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Rocket Number</label>
                            <input type="text" id="set-rocket" class="form-control">
                        </div>
                        <button class="btn btn-dark w-100" onclick="savePaymentSettings()">Update Payment Info</button>
                    </div>
                     <div class="card-box">
                        <h6 class="mb-3 text-primary"><i class="fas fa-headset"></i> Support</h6>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Telegram/Support URL</label>
                            <input type="text" id="set-support" class="form-control">
                        </div>
                        <button class="btn btn-dark w-100" onclick="saveLinks()">Update Support</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOTIFICATIONS VIEW -->
        <div id="view-notifications" class="hidden">
            <h4 class="fw-bold">Push Notifications</h4>
            <div class="row mt-3">
                <div class="col-md-5">
                    <div class="card-box">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" id="notif-title" class="form-control" placeholder="Match Alert!">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Message</label>
                            <textarea id="notif-body" class="form-control" rows="3" placeholder="Join Erangel squad now..."></textarea>
                        </div>
                        <button class="btn btn-warning w-100 text-white fw-bold" onclick="sendNotification()">Send Notification</button>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card-box">
                        <h6 class="mb-3">Recent Notifications</h6>
                        <ul class="list-group list-group-flush" id="prev-notifs"></ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL: PARTICIPANTS -->
    <div class="modal fade" id="participantModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Match Participants</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-striped mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-3">#</th>
                                <th>Player IGN</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="part-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD CATEGORY -->
    <div class="modal fade" id="catModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Add Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Category Name</label>
                        <input type="text" id="cat-name" class="form-control" placeholder="e.g., Free Fire">
                    </div>
                    
                    <label class="form-label">Category Image</label>
                    <div class="modal-tabs">
                        <div class="m-tab active" id="tab-cat-upload" onclick="switchImageTab('cat', 'upload')">Upload</div>
                        <div class="m-tab" id="tab-cat-link" onclick="switchImageTab('cat', 'link')">Direct Link</div>
                    </div>
                    
                    <div id="content-cat-upload">
                        <input type="file" id="cat-file" class="form-control" accept="image/*" onchange="previewImage(this, 'cat-preview')">
                    </div>
                    <div id="content-cat-link" class="hidden">
                        <input type="text" id="cat-url-input" class="form-control" placeholder="https://image.com/pic.jpg" oninput="previewUrl(this.value, 'cat-preview')">
                    </div>

                    <div class="img-preview-box" id="cat-preview">
                        <span class="text-muted small">Image Preview</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="saveCategory()">Save Category</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD BANNER -->
    <div class="modal fade" id="bannerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Add Slider Banner</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">Banner Image</label>
                    <div class="modal-tabs">
                        <div class="m-tab active" id="tab-ban-upload" onclick="switchImageTab('ban', 'upload')">Upload</div>
                        <div class="m-tab" id="tab-ban-link" onclick="switchImageTab('ban', 'link')">Direct Link</div>
                    </div>
                    
                    <div id="content-ban-upload">
                        <input type="file" id="ban-file" class="form-control" accept="image/*" onchange="previewImage(this, 'ban-preview')">
                    </div>
                    <div id="content-ban-link" class="hidden">
                        <input type="text" id="ban-url-input" class="form-control" placeholder="https://image.com/banner.jpg" oninput="previewUrl(this.value, 'ban-preview')">
                    </div>

                    <div class="img-preview-box" id="ban-preview">
                        <span class="text-muted small">Image Preview</span>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Click Link (Optional)</label>
                        <input type="text" id="ban-link" class="form-control" placeholder="https://youtube.com...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="saveBanner()">Save Banner</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD/EDIT MATCH -->
    <div class="modal fade" id="matchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="matchModalLabel">Match Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="m-key">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Title</label>
                            <input type="text" id="m-title" class="form-control" placeholder="T3 - Squad Match">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Category</label>
                            <select id="m-category" class="form-select"></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Date Time</label>
                            <input type="datetime-local" id="m-date" class="form-control">
                        </div>
                         <div class="col-md-6">
                            <label class="form-label small text-muted">Map</label>
                            <input type="text" id="m-map" class="form-control" value="Erangel">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Entry Fee</label>
                            <input type="number" id="m-entry" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Total Prize</label>
                            <input type="number" id="m-prize" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Per Kill</label>
                            <input type="number" id="m-perkill" class="form-control">
                        </div>
                         <div class="col-md-6">
                            <label class="form-label small text-muted">Type</label>
                            <select id="m-type" class="form-select">
                                <option value="Solo">Solo</option>
                                <option value="Duo">Duo</option>
                                <option value="Squad">Squad</option>
                            </select>
                        </div>
                         <div class="col-md-6">
                            <label class="form-label small text-muted">Total Spots</label>
                            <input type="number" id="m-total" class="form-control" value="48">
                        </div>
                        
                        <div class="col-12"><hr class="text-muted"></div>
                        <div class="col-md-4">
                            <label class="form-label text-primary fw-bold">Status</label>
                            <select id="m-status" class="form-select">
                                <option value="Upcoming">Upcoming</option>
                                <option value="Ongoing">Ongoing (Hide)</option>
                                <option value="Finished">Finished (Show Result)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-primary fw-bold">Room ID</label>
                            <input type="text" id="m-room-id" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-primary fw-bold">Room Pass</label>
                            <input type="text" id="m-room-pass" class="form-control">
                        </div>
                         <div class="col-12">
                            <label class="form-label">Prize Distribution / Results</label>
                            <textarea id="m-desc" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="saveMatch()">Save Match</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: BALANCE -->
    <div class="modal fade" id="balanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Manage Balance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>User: <strong id="bal-username" class="text-primary">--</strong></p>
                    <input type="hidden" id="bal-uid">
                    <select id="bal-action" class="form-select mb-3">
                        <option value="add_dep">Add Deposit (+)</option>
                        <option value="rem_dep">Deduct Deposit (-)</option>
                        <option value="add_win">Add Winning (+)</option>
                        <option value="rem_win">Deduct Winning (-)</option>
                    </select>
                    <input type="number" id="bal-amount" class="form-control" placeholder="Amount">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="submitBalanceUpdate()">Update Balance</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

       const firebaseConfig = {
  apiKey: "AIzaSyCDFiHxEK4CbEDe_YVpg0Ub_k40xS88wRU",
  authDomain: "games-club-bd-e00f0.firebaseapp.com",
  databaseURL: "https://games-club-bd-e00f0-default-rtdb.firebaseio.com",
  projectId: "games-club-bd-e00f0",
  storageBucket: "games-club-bd-e00f0.firebasestorage.app",
  messagingSenderId: "999046379000",
  appId: "1:999046379000:web:71d51d6a637d760d71120d",
  measurementId: "G-ZTESM0K5SH"
};
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ImgBB API Key
        const IMGBB_API_KEY = "77f9b7d455f8249ce4ff0303d7956899";

        let allMatches = {}, allUsers = {}, allCategories = {};
        let modals = {};
        let mainChart = null, pieChart = null;
        let activeImageTabs = { cat: 'upload', ban: 'upload' };

        window.onload = () => {
            modals.match = new bootstrap.Modal(document.getElementById('matchModal'));
            modals.cat = new bootstrap.Modal(document.getElementById('catModal'));
            modals.banner = new bootstrap.Modal(document.getElementById('bannerModal'));
            modals.balance = new bootstrap.Modal(document.getElementById('balanceModal'));
            modals.participants = new bootstrap.Modal(document.getElementById('participantModal'));

            fetchDashboardData();
            fetchSettings();
        };

        // --- UI UTILS ---
        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.nav-overlay').classList.toggle('active');
        };
        
        window.switchView = (view, elem) => {
            document.querySelectorAll('.main-content > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('view-'+view).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
            if(elem) elem.classList.add('active');
            
            if(window.innerWidth < 768) {
                 document.getElementById('sidebar').classList.remove('active');
                 document.querySelector('.nav-overlay').classList.remove('active');
            }

            if(view === 'matches') fetchMatches();
            if(view === 'categories') fetchCategories();
            if(view === 'sliders') fetchSliders();
            if(view === 'users') fetchUsers();
            if(view === 'withdraw') fetchWithdrawals();
            if(view === 'notifications') fetchNotifications();
        }

        window.switchImageTab = (modalType, tabType) => {
            activeImageTabs[modalType] = tabType;
            // Update Tab UI
            document.getElementById(`tab-${modalType}-upload`).classList.remove('active');
            document.getElementById(`tab-${modalType}-link`).classList.remove('active');
            document.getElementById(`tab-${modalType}-${tabType}`).classList.add('active');
            
            // Show Content
            document.getElementById(`content-${modalType}-upload`).classList.add('hidden');
            document.getElementById(`content-${modalType}-link`).classList.add('hidden');
            document.getElementById(`content-${modalType}-${tabType}`).classList.remove('hidden');
        }

        window.previewImage = (input, targetId) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById(targetId).innerHTML = `<img src="${e.target.result}">`;
                reader.readAsDataURL(input.files[0]);
            }
        }
        window.previewUrl = (url, targetId) => {
            if(url) document.getElementById(targetId).innerHTML = `<img src="${url}">`;
        }

        // --- IMGBB UPLOAD FUNCTION ---
        async function uploadToImgBB(fileInputId) {
            const input = document.getElementById(fileInputId);
            if (!input.files || !input.files[0]) return null;

            document.getElementById('loading').classList.remove('hidden');
            const file = input.files[0];
            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: "POST",
                    body: formData
                });
                const data = await response.json();
                document.getElementById('loading').classList.add('hidden');
                
                if (data.success) {
                    return data.data.url;
                } else {
                    alert("Upload Failed: " + (data.error ? data.error.message : "Unknown error"));
                    return null;
                }
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                console.error(error);
                alert("Upload Error. Check Console.");
                return null;
            }
        }

        // --- DASHBOARD ---
        function renderCharts(usersCount, matchesCount, totalDep, totalWin) {
            if(mainChart) mainChart.destroy();
            if(pieChart) pieChart.destroy();

            mainChart = new Chart(document.getElementById('mainChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Users', 'Matches'],
                    datasets: [{
                        label: 'Count', data: [usersCount, matchesCount],
                        backgroundColor: ['#4361ee', '#ef4444'], borderRadius: 10
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            pieChart = new Chart(document.getElementById('pieChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Deposit', 'Winnings'],
                    datasets: [{ data: [totalDep, totalWin], backgroundColor: ['#10b981', '#f97316'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function fetchDashboardData() {
            onValue(ref(db, 'users'), s => {
                const d = s.val() || {};
                allUsers = d;
                const uCount = Object.keys(d).length;
                document.getElementById('dash-users').innerText = uCount;
                
                let tDep = 0, tWin = 0;
                Object.values(d).forEach(u => { tDep += (parseFloat(u.deposit)||0); tWin += (parseFloat(u.winning)||0); });
                document.getElementById('dash-deposit').innerText = tDep.toFixed(0);

                get(ref(db, 'matches')).then(snap => {
                    const mCount = snap.exists() ? Object.keys(snap.val()).length : 0;
                    document.getElementById('dash-matches').innerText = mCount;
                    renderCharts(uCount, mCount, tDep, tWin);
                });
            });
            onValue(ref(db, 'transactions'), s => {
                let pending = 0;
                if(s.exists()) Object.values(s.val()).forEach(uT => Object.values(uT).forEach(t => { if(t.type==='Withdraw' && t.status==='Pending') pending++; }));
                document.getElementById('dash-pending').innerText = pending;
            });
        }

        // --- CATEGORIES (AUTO ID 1, 2, 3...) ---
        function fetchCategories() {
            onValue(ref(db, 'categories'), s => {
                const d = s.val() || {};
                allCategories = d;
                const g = document.getElementById('cat-grid');
                g.innerHTML = "";
                Object.entries(d).forEach(([k, v]) => {
                    g.innerHTML += `
                    <div class="col-6 col-md-3">
                        <div class="card-box p-3 text-center h-100 position-relative">
                            <span class="badge bg-light text-dark position-absolute top-0 start-0 m-2 border">ID: ${k}</span>
                            <img src="${v.img}" style="width:100%; height:120px; object-fit:cover; border-radius:12px; margin-top:10px;">
                            <h6 class="mt-3 fw-bold">${v.name}</h6>
                            <button class="btn btn-sm btn-outline-danger w-100 mt-2" onclick="removeCategory('${k}')">Remove</button>
                        </div>
                    </div>`;
                });
            });
        }

        window.openCategoryModal = () => {
            document.getElementById('cat-name').value = "";
            document.getElementById('cat-file').value = "";
            document.getElementById('cat-url-input').value = "";
            document.getElementById('cat-preview').innerHTML = "<span class='text-muted small'>Image Preview</span>";
            switchImageTab('cat', 'upload');
            modals.cat.show();
        }

        window.saveCategory = async () => {
            const name = document.getElementById('cat-name').value;
            if(!name) return alert("Name required");
            
            let imageUrl = "";
            if(activeImageTabs.cat === 'upload') {
                imageUrl = await uploadToImgBB('cat-file');
            } else {
                imageUrl = document.getElementById('cat-url-input').value;
            }
            if(!imageUrl) return alert("Image required");

            get(ref(db, 'categories')).then(snapshot => {
                const cats = snapshot.val() || {};
                let maxId = 0;
                Object.keys(cats).forEach(key => {
                    if(!isNaN(key)) {
                        const num = parseInt(key);
                        if(num > maxId) maxId = num;
                    }
                });
                const newId = (maxId + 1).toString();
                set(ref(db, 'categories/' + newId), { name: name, img: imageUrl }).then(() => {
                    modals.cat.hide();
                    alert(`Category Added with ID: ${newId}`);
                });
            });
        }
        window.removeCategory = (k) => { if(confirm("Delete this category?")) remove(ref(db, 'categories/'+k)); }

        // --- SLIDERS ---
        function fetchSliders() {
            onValue(ref(db, 'app_settings/banners'), s => {
                const g = document.getElementById('banner-grid');
                g.innerHTML = "";
                if(s.exists()) Object.entries(s.val()).forEach(([k, v]) => {
                    g.innerHTML += `
                    <div class="col-12 col-md-6">
                        <div class="card-box p-0 overflow-hidden position-relative h-100">
                            <img src="${v.img}" style="width:100%; height:200px; object-fit:cover;">
                            <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-3 shadow" onclick="removeBanner('${k}')"><i class="fas fa-trash"></i></button>
                            <div class="p-3 bg-white border-top">
                                <small class="text-muted d-block">Link: ${v.link || 'None'}</small>
                            </div>
                        </div>
                    </div>`;
                });
            });
        }
        window.openBannerModal = () => {
            document.getElementById('ban-file').value = "";
            document.getElementById('ban-url-input').value = "";
            document.getElementById('ban-link').value = "";
            document.getElementById('ban-preview').innerHTML = "<span class='text-muted small'>Image Preview</span>";
            switchImageTab('ban', 'upload');
            modals.banner.show();
        }
        window.saveBanner = async () => {
            let imageUrl = "";
            if(activeImageTabs.ban === 'upload') {
                imageUrl = await uploadToImgBB('ban-file');
            } else {
                imageUrl = document.getElementById('ban-url-input').value;
            }
            if(!imageUrl) return alert("Image required");

            const link = document.getElementById('ban-link').value;
            push(ref(db, 'app_settings/banners'), { img: imageUrl, link: link }).then(() => {
                modals.banner.hide();
                alert("Banner Added!");
            });
        }
        window.removeBanner = (k) => { if(confirm("Delete?")) remove(ref(db, 'app_settings/banners/'+k)); }

        // --- MATCHES ---
        function fetchMatches() {
            onValue(ref(db, 'matches'), s => {
                const tb = document.getElementById('matches-table-body');
                tb.innerHTML = "";
                const d = s.val();
                if(!d) { tb.innerHTML="<tr><td colspan='8' class='text-center p-3 text-muted'>No Matches Found</td></tr>"; return;}

                allMatches = d;
                Object.entries(d).reverse().forEach(([k, m]) => {
                    let badge = m.status=='Upcoming'?'bg-primary':(m.status=='Ongoing'?'bg-success':'bg-secondary');
                    tb.innerHTML += `
                    <tr>
                        <td><small class="text-muted">${m.id}</small></td>
                        <td>
                            <div class="fw-bold text-dark">${m.title}</div>
                            <small class="text-muted">${m.map} • ${m.entry}TK</small>
                        </td>
                        <td>${m.time}</td>
                        <td>${m.type}</td>
                        <td>${m.room_id||'--'}<br><small class="text-muted">${m.room_pass||'--'}</small></td>
                        <td><span class="badge ${badge}">${m.status}</span></td>
                        <td>${m.joined||0}/${m.total}</td>
                        <td>
                            <button class="btn btn-sm btn-info text-white border me-1" onclick="viewParticipants('${m.id}', '${k}')"><i class="fas fa-users"></i></button>
                            <button class="btn btn-sm btn-light text-primary border me-1" onclick="editMatch('${k}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-light text-danger border" onclick="deleteMatch('${k}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            });
            onValue(ref(db, 'categories'), s => {
                const sel = document.getElementById('m-category');
                sel.innerHTML = "";
                if(s.exists()) Object.entries(s.val()).forEach(([k,v]) => sel.innerHTML += `<option value="${k}">${v.name} (ID: ${k})</option>`);
            });
        }

        window.openMatchModal = () => {
            document.getElementById('m-key').value = "";
            document.getElementById('matchModalLabel').innerText = "Create New Match";
            ['m-title','m-date','m-entry','m-prize','m-perkill','m-room-id','m-room-pass','m-desc'].forEach(id=>document.getElementById(id).value="");
            modals.match.show();
        }
        window.editMatch = (k) => {
            const m = allMatches[k];
            document.getElementById('m-key').value = k;
            document.getElementById('matchModalLabel').innerText = "Edit Match";
            document.getElementById('m-title').value = m.title;
            document.getElementById('m-category').value = m.categoryId;
            document.getElementById('m-map').value = m.map;
            document.getElementById('m-entry').value = m.entry;
            document.getElementById('m-prize').value = m.total_prize;
            document.getElementById('m-perkill').value = m.per_kill;
            document.getElementById('m-type').value = m.type;
            document.getElementById('m-total').value = m.total;
            document.getElementById('m-status').value = m.status;
            document.getElementById('m-room-id').value = m.room_id||"";
            document.getElementById('m-room-pass').value = m.room_pass||"";
            document.getElementById('m-desc').value = m.prize_desc||"";
            modals.match.show();
        }
        window.saveMatch = () => {
            const key = document.getElementById('m-key').value;
            const title = document.getElementById('m-title').value;
            const entry = parseInt(document.getElementById('m-entry').value);
            const dateIn = document.getElementById('m-date').value;
            if(!title || isNaN(entry)) return alert("Required fields missing");

            let timeStr = "TBA", ts = Date.now();
            if(dateIn) {
                const d = new Date(dateIn);
                timeStr = d.toLocaleString('en-US', {month:'short', day:'numeric', hour:'numeric', minute:'numeric', hour12:true});
                ts = d.getTime();
            }

            const data = {
                title, entry, time: timeStr, timestamp: ts,
                categoryId: document.getElementById('m-category').value,
                map: document.getElementById('m-map').value,
                total_prize: parseInt(document.getElementById('m-prize').value)||0,
                per_kill: parseInt(document.getElementById('m-perkill').value)||0,
                type: document.getElementById('m-type').value,
                total: parseInt(document.getElementById('m-total').value)||48,
                status: document.getElementById('m-status').value,
                room_id: document.getElementById('m-room-id').value,
                room_pass: document.getElementById('m-room-pass').value,
                prize_desc: document.getElementById('m-desc').value
            };

            if(key) update(ref(db, 'matches/'+key), data).then(()=>{ modals.match.hide(); alert("Updated"); });
            else {
                data.id = Math.floor(1000+Math.random()*9000);
                data.joined = 0;
                push(ref(db, 'matches'), data).then(()=>{ modals.match.hide(); alert("Created"); });
            }
        }
        window.deleteMatch = (k) => { if(confirm("Delete?")) remove(ref(db, 'matches/'+k)); }

        // --- PARTICIPANTS LOGIC (NEW) ---
        window.viewParticipants = (matchId, matchKey) => {
            const list = document.getElementById('part-list');
            list.innerHTML = '<tr><td colspan="3" class="text-center">Loading...</td></tr>';
            modals.participants.show();

            onValue(ref(db, 'match_participants/' + matchId), (snap) => {
                list.innerHTML = "";
                if (snap.exists()) {
                    let count = 0;
                    Object.entries(snap.val()).forEach(([pKey, p]) => {
                        count++;
                        list.innerHTML += `
                            <tr>
                                <td class="ps-3">${count}</td>
                                <td>
                                    <div class="fw-bold text-dark">${p.ign}</div>
                                    <small class="text-muted">UID: ${p.joinedBy || 'N/A'}</small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" onclick="kickPlayer('${matchId}', '${pKey}', '${matchKey}')">Kick</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    list.innerHTML = '<tr><td colspan="3" class="text-center text-muted p-3">No Participants Joined Yet</td></tr>';
                }
            });
        }

        window.kickPlayer = (matchId, pKey, matchKey) => {
            if (confirm("Are you sure you want to remove this player?")) {
                // Remove from participants list
                remove(ref(db, `match_participants/${matchId}/${pKey}`)).then(() => {
                    // Decrement Joined Count in Match
                    get(ref(db, `matches/${matchKey}/joined`)).then((snap) => {
                        let current = snap.val() || 0;
                        if (current > 0) {
                            update(ref(db, `matches/${matchKey}`), { joined: current - 1 });
                        }
                    });
                    alert("Player Removed");
                });
            }
        }

        // --- USERS & BALANCE ---
        function fetchUsers() { renderUsers(); }
        window.renderUsers = () => {
            const term = document.getElementById('user-search').value.toLowerCase();
            const tb = document.getElementById('users-table-body');
            tb.innerHTML = "";
            const entries = Object.entries(allUsers);
            if(!entries.length) tb.innerHTML = "<tr><td colspan='5' class='text-center p-3'>No Users</td></tr>";

            entries.forEach(([uid, u]) => {
                if(term && !u.username.toLowerCase().includes(term) && !uid.includes(term)) return;
                tb.innerHTML += `
                <tr>
                    <td><b>${u.username||'Guest'}</b><br><small class="text-muted">${uid}</small></td>
                    <td>${u.email||u.phone||'--'}</td>
                    <td class="text-success fw-bold">${u.deposit||0}</td>
                    <td class="text-primary fw-bold">${u.winning||0}</td>
                    <td><button class="btn btn-sm btn-light border" onclick="openBalModal('${uid}','${u.username}')">Edit Bal</button></td>
                </tr>`;
            });
        }
        window.openBalModal = (id, name) => {
            document.getElementById('bal-uid').value = id;
            document.getElementById('bal-username').innerText = name;
            document.getElementById('bal-amount').value = "";
            modals.balance.show();
        }
        window.submitBalanceUpdate = () => {
            const uid = document.getElementById('bal-uid').value;
            const act = document.getElementById('bal-action').value;
            const amt = parseFloat(document.getElementById('bal-amount').value);
            if(!amt) return alert("Enter amount");
            
            const u = allUsers[uid];
            let up = {};
            let cd = parseFloat(u.deposit)||0, cw = parseFloat(u.winning)||0;

            if(act.includes('dep')) up.deposit = act=='add_dep' ? cd+amt : cd-amt;
            else up.winning = act=='add_win' ? cw+amt : cw-amt;

            update(ref(db, 'users/'+uid), up).then(() => {
                push(ref(db, 'transactions/'+uid), { type: 'Admin Adj', amount: amt, method: 'Manual', status: 'Success', date: new Date().toLocaleString() });
                modals.balance.hide();
                alert("Done");
            });
        }

        // --- WITHDRAW & SETTINGS ---
        function fetchWithdrawals() {
            onValue(ref(db, 'transactions'), s => {
                const tb = document.getElementById('withdraw-table-body');
                tb.innerHTML = "";
                let count = 0;
                if(s.exists()) Object.entries(s.val()).forEach(([uid, trs]) => {
                    Object.entries(trs).forEach(([tid, t]) => {
                        if(t.type === 'Withdraw' && t.status === 'Pending') {
                            count++;
                            tb.innerHTML += `
                            <tr>
                                <td><small>${uid}</small></td>
                                <td class="fw-bold text-danger">${t.amount}</td>
                                <td>${t.method}</td>
                                <td>${t.number}</td>
                                <td>${t.date}</td>
                                <td><span class="badge bg-warning text-dark">Pending</span></td>
                                <td>
                                    <button class="btn btn-sm btn-success" onclick="procW('${uid}','${tid}',1)"><i class="fas fa-check"></i></button>
                                    <button class="btn btn-sm btn-danger" onclick="procW('${uid}','${tid}',0,${t.amount})"><i class="fas fa-times"></i></button>
                                </td>
                            </tr>`;
                        }
                    });
                });
                if(count === 0) tb.innerHTML = "<tr><td colspan='7' class='text-center p-3 text-muted'>No Pending Requests</td></tr>";
            });
        }
        window.procW = (u, t, ok, amt) => {
            if(ok) { if(confirm("Mark Paid?")) update(ref(db, `transactions/${u}/${t}`), {status:'Success'}); }
            else { if(confirm("Reject?")) { update(ref(db, `transactions/${u}/${t}`), {status:'Failed'}); get(ref(db, `users/${u}/winning`)).then(s => update(ref(db, `users/${u}`), {winning: (parseFloat(s.val())||0)+amt})); } }
        }

        function fetchSettings() {
            onValue(ref(db, 'app_settings'), s => {
                const d = s.val() || {};
                document.getElementById('set-bkash').value = d.bkash_number||"";
                document.getElementById('set-nagad').value = d.nagad_number||"";
                document.getElementById('set-rocket').value = d.rocket_number||"";
                document.getElementById('set-support').value = d.support_link||"";
                document.getElementById('set-vid-money').value = d.how_to_add_money_link||"";
                document.getElementById('set-vid-room').value = d.how_to_get_room_id_link||"";
                document.getElementById('set-vid-play').value = d.how_to_play_link||"";
                document.getElementById('set-notice').value = d.notice||"";
            });
        }
        window.saveLinks = () => update(ref(db, 'app_settings'), {
            support_link: document.getElementById('set-support').value,
            how_to_add_money_link: document.getElementById('set-vid-money').value,
            how_to_get_room_id_link: document.getElementById('set-vid-room').value,
            how_to_play_link: document.getElementById('set-vid-play').value
        }).then(()=>alert("Saved"));
        
        window.savePaymentSettings = () => update(ref(db, 'app_settings'), {
            bkash_number: document.getElementById('set-bkash').value,
            nagad_number: document.getElementById('set-nagad').value,
            rocket_number: document.getElementById('set-rocket').value
        }).then(()=>alert("Saved"));

        window.saveNotice = () => update(ref(db, 'app_settings'), {notice:document.getElementById('set-notice').value}).then(()=>alert("Saved"));

        function fetchNotifications() {
            onValue(ref(db, 'notifications'), s=>{
                const l = document.getElementById('prev-notifs');
                l.innerHTML = "";
                if(s.exists()) Object.values(s.val()).reverse().forEach(n => l.innerHTML+=`<li class="list-group-item"><b>${n.title}</b>: ${n.body}</li>`);
            });
        }
        window.sendNotification = () => {
            const t = document.getElementById('notif-title').value, b = document.getElementById('notif-body').value;
            if(t&&b) push(ref(db, 'notifications'), {title:t, body:b, date: new Date().toLocaleString()}).then(()=>{alert("Sent"); document.getElementById('notif-title').value="";});
        }
    </script>
</body>
</html>